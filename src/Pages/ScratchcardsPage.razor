@page "/scratchcards"
@using System.Collections.Frozen
@using ScratchcardStatistics.Models
@using ScratchcardStatistics.Services
@inject NavigationManager NavigationManager

<PageTitle>Kaparós sorsjegyek</PageTitle>

@if (_scratchcardsFiltered is not null)
{
    <FluentDataGrid Items="@_scratchcardsFiltered" OnRowFocus="HandleRowFocus" TGridItem="Scratchcard" ShowHover>
        <PropertyColumn Property="@(s => s.Name)" Title="Név" Sortable=true Filtered="!string.IsNullOrEmpty(_filterName)">
            <ColumnOptions>
                <FluentSearch Autofocus=true @bind-Value=_filterName @oninput="NameChanged" @bind-Value:after="NameCleared" Label="Szűrés" Placeholder="Név" />
            </ColumnOptions>
        </PropertyColumn>
        <PropertyColumn Property="@(s => s.ReleaseDate)" InitialSortDirection=SortDirection.Descending IsDefaultSortColumn=true Title="Megjelenés" Align=Align.Center Sortable=true  />
        <PropertyColumn Property="@(s => s.Price)" Format="C0" Title="Ár" Align=Align.End Sortable=true />
        <PropertyColumn Property="@(s => s.ExpectedValue)" Format="C0" Title="Várható érték" Align=Align.End Sortable=true />
        <PropertyColumn Property="@(s => s.ExpectedValuePercent)" Format="P0" Title="Várható érték %" Align=Align.Center Sortable=true />
        <TemplateColumn Title="Nyerési esély" Align=Align.Center Sortable=true SortBy="@chanceOfWinningToOneSort">1:@(context.ChanceOfWinningToOne.ToString("N2"))</TemplateColumn>
        <PropertyColumn Property="@(s => s.ChanceOfWinningPercent)" Format="P2" Title="Nyerési esély %" Align=Align.Center Sortable=true />
        <TemplateColumn Title="Elérhető" Align=Align.Center Sortable=true SortBy="@isAvailableSort" Filtered="_filterIsAvailable is not null">
            <ColumnOptions>
                <FluentCheckbox ThreeState=true CheckState=_filterIsAvailable CheckStateChanged=IsAvailableChanged Label="Elérhető" />
            </ColumnOptions>
			<ChildContent>
				@if (context.IsAvailable)
				{
					<FluentEmoji Value="@(new Emojis.Symbols.Flat.Default.CheckMarkButton())" Width="16px" />
				}
				else
				{
					<FluentEmoji Value="@(new Emojis.Symbols.Flat.Default.CrossMark())" Width="16px" />
				}
			</ChildContent>
		</TemplateColumn>
	</FluentDataGrid>
}

@code {
    private string _filterName = string.Empty;
    private bool? _filterIsAvailable = true;

    private IQueryable<Scratchcard>? _scratchcardsFiltered;

    private GridSort<Scratchcard> chanceOfWinningToOneSort = GridSort<Scratchcard>.ByAscending(x => x.ChanceOfWinningToOne);
    private GridSort<Scratchcard> isAvailableSort = GridSort<Scratchcard>.ByAscending(x => x.IsAvailable);

    protected override void OnInitialized() =>
        FilterChanged();

    private void NameChanged(ChangeEventArgs args)
    {
        if (args.Value is string value)
        {
            _filterName = value;
            FilterChanged();
        }
    }

    private void NameCleared()
    {
        if (string.IsNullOrWhiteSpace(_filterName))
        {
            _filterName = string.Empty;
            FilterChanged();
        }
    }

    private void IsAvailableChanged(bool? isSelected)
    {
        _filterIsAvailable = isSelected;
        FilterChanged();
    }

    private void FilterChanged() =>
        _scratchcardsFiltered = ScratchcardService.Scratchcards
            .Where(s => s.Name.Contains(_filterName, StringComparison.OrdinalIgnoreCase))
            .Where(s => _filterIsAvailable.HasValue ? s.IsAvailable == _filterIsAvailable : true)
			.OrderByDescending(s => s.ReleaseDate)
			.ThenByDescending(s => s.Price)
            .AsQueryable();

    private void HandleRowFocus(FluentDataGridRow<Scratchcard> row) =>
        NavigationManager.NavigateTo($"scratchcards/{row.Item!.PathName}");
}
